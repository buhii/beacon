// mito.js
// for TBS 2010/11/08
// written by Takahiro Kamatani

inlets = 1;
outlets = 3;
tune_mode = 0;
old_num = 999;
tune = new Array(2);

LASEROFF  = 4398764;
LASERON   = 6983059;
TUNEEND	  = 5498725;
NO_NOTE	  = 36660;

now_note = NO_NOTE;


/* -------------------------------------*/
/*                GameOver              */
/* -------------------------------------*/

tune[0] = [
	[999,999,999, LASEROFF ],
	[999,999,999, 999],
	[999,999,999, 33],
	[999,999,999, 999],
	[999,999,999, 33],
	[999,999,999, 999],
	];

/* -------------------------------------*/
/*            Mito KoMon                */
/* -------------------------------------*/

tune[1] = [
	[999,999,999, LASEROFF],
	[999,999,999, 999],
	[999,999,999, 33],
	[999,999,999, 33],
	[999,999,999, 33],
	[999,999,999, 33],

	[65, 66, 67, LASERON],
	[64, 65, 66, 999],
	[62, 63, 64, 999],
	[64, 65, 66, 999],
	[65, 66, 67, 999],
	[65, 66, 67, 999],
	[64, 65, 66, 999],
	[62, 63, 64, 999],

	[64, 65, 66, 999],
	[62, 63, 64, 999],
	[61, 62, 63, 999],
	[58, 59, 60, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],

	[55, 56, 57, 999],
	[55, 56, 57, 999],
	[58, 59, 60, 999],
	[55, 56, 57, 999],
	[58, 59, 60, 999],
	[58, 59, 60, 999],
	[62, 63, 64, 999],
	[61, 62, 63, 999],

	[60, 61, 62, 999],
	[61, 62, 63, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],

	[65, 66, 67, 999],
	[65, 66, 67, 999],
	[65, 66, 67, 999],
	[65, 66, 67, 999],
	[65, 66, 67, 999],
	[65, 66, 67, 999],
	[64, 65, 66, 999],
	[64, 65, 66, 999],

	[65, 66, 67, 999],
	[65, 66, 67, 999],
	[70, 71, 72, 999],
	[68, 69, 70, 999],
	[65, 66, 67, 999],
	[65, 66, 67, 999],
	[64, 65, 66, 999],
	[64, 65, 66, 999],

	[62, 63, 64, 999],
	[62, 63, 64, 999],
	[62, 63, 64, 999],
	[62, 63, 64, 999],
	[62, 63, 64, 999],
	[62, 63, 64, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],

	[61, 62, 63, 999],
	[61, 62, 63, 999],
	[61, 62, 63, 999],
	[61, 62, 63, 999],
	[61, 62, 63, 999],
	[61, 62, 63, 999],
	[61, 62, 63, 999],
	[61, 62, 63, 999],

	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[58, 59, 60, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[62, 63, 64, 999],
	[61, 62, 63, 999],

	[61, 62, 63, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[58, 59, 60, 999],
	[55, 56, 57, 999],
	[55, 56, 57, 999],
	[58, 59, 60, 999],
	[58, 59, 60, 999],

	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999],
	[60, 61, 62, 999]
	];

/* -------------------------------------*/
/*               function               */
/* -------------------------------------*/
function setFlag(x)
{
	outlet(2, x);
}

function list(a)
{
	cmt = arguments[0];		// Chikai Man-naka Tooi
	num = arguments[1];		// tick
	ac  = tune[tune_mode][num][3];	// accompaniment /w flag

	// output Off
	if (num == (tune[tune_mode].length - 1) ) { setFlag(TUNEEND); }

	// output accompaniment, flag
	if (old_num != num) {
		switch (ac) {
		case LASEROFF: 	setFlag(LASEROFF); break;
		case LASERON: 	setFlag(LASERON); cmt = -1; break;
		case 999:	break;
		default:	outlet(1, ac);	// accompaniment
		}
	}
	old_num = num;

	// output tune
	if (cmt == -1) {
		if (now_note != NO_NOTE) {
			outlet(0, [now_note, 0]);	// note off
			now_note = NO_NOTE;
		}
		flag_con = true;
	} else {
		if (flag_con == true)
		{	
			if (tune[tune_mode][num][cmt] != 999) {
				now_note = tune[tune_mode][num][cmt];
				outlet(0, [now_note, 127]);	// note on
			}
		}
		flag_con = false;
	}
}

function msg_int(x)
{
	if (x == 1) { post("Mario\n");	  tune_mode = 1; old_num = 999; return; }
	if (x == 3) { post("GameOver\n"); tune_mode = 0; old_num = 999; return; }
}